pipeline {
   agent {
       label 'CD-Jenkins-Slave'
    }
    
    environment {
    dockerimagename = "vijaylokesh/my-tomcat:latest"
    registry = "https://hub.docker.com/"
    registryCredential = 'my-docker-private-id'
    container_name= 'vijaylokesh-my-tomcat'
	  
    }    

    stages {
        stage ('Checkout SCM') {

            steps {
               checkout scm
            }
        }


     // Stopping Docker containers for cleaner Docker run
    stage('stop previous containers') {
         steps {
            
            sh 'docker ps -f name=container_name -q | xargs --no-run-if-empty docker container stop'
            sh 'docker container ls -a -fname=container_name -q | xargs -r docker container rm'
         }
       }
      
    stage('Docker Run') {
       steps{
          
          script {
         
           docker.withRegistry('https://registry.hub.docker.com', registryCredential ) {
           image = docker.image('vijaylokesh/my-tomcat:latest')
           image.pull()
         
           sh "docker run -d -p 8080:8080 --rm --name container_name registry.hub.docker.com/vijaylokesh/my-tomcat:latest"
           }
         }  

         }
      }  
    
    }
  }


